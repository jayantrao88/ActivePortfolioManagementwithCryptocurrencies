---
title: "5c Backtesting CryptoFund"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

For Backtesting we follow the below steps:

1) Compare CryptoFund, Individual Cryptos, and Sp500 Return performance
   For the Performance Metrics of the three portfolios, we use the below indicators
    i) Evolution over the investment period
   ii) Annualized Mean
   iii) Annualized Standard Deviation 
   iv) Compounded Annual Growth Rate (CAGR)
   
2) Weights Graph of Cryptocurrencies for each period 

All the above is carried on a combination of the below for the CryptoFund:

Distribution and Copula Type  | Optimization  
----------------------------- | ------------------
Parametric and R Vine Copula  |  Min.Var      
Parametric and C Vine Copula  |  Min.ES        
Empirical  and R Vine Copula  |  Sharpe        
Empirical  and C Vine Copula  |  Starr and MaxMean 

```{r, echo=FALSE}
library(fBasics)
library(readxl)
library(gdata)
library(PortfolioAnalytics)
library(PerformanceAnalytics)
library(ROI)
library(flextable)
library(officer)
library(dplyr)
library(gdata)
library(profvis)
library(tictoc)
library(xts)
library(rlist)
library(magrittr)
library(tidyr)
```

```{r}
multiple.fun <- function(x){
    Dt <- xts::last(x) %>% index %>% as.Date}
```

```{r}
NoofRebalancingPeriod <- length(SubFullBackTesting)
NoofAssets <- ncol(SubFullBackTesting[[NoofRebalancingPeriod]])

a<- lapply(SubFullBackTesting, multiple.fun)
a<- Reduce(c,a)

AssetReturns <- as.data.frame(matrix(nrow = NoofRebalancingPeriod, ncol = NoofAssets, dimnames = list(NULL,colnames(SubFullBackTesting[[NoofRebalancingPeriod]]))))

TempDate <- matrix(matrix(nrow = NoofRebalancingPeriod, ncol = 1))

for(PeriodNo in 1:NoofRebalancingPeriod){
   AssetReturns[PeriodNo,colnames(SubFullBackTesting[[PeriodNo]])] <-
      xts::last(SubFullBackTesting[[PeriodNo]],n = 30) %>% colSums() %>% expm1() #Converting ln(r) to arithematic returns
   TempDate[PeriodNo,] <- as.character(a[[PeriodNo]]) 
}

AssetReturns <- as.xts(AssetReturns, order.by = as.Date(TempDate))


rm(a,NoofRebalancingPeriod,NoofAssets,PeriodNo)

```


DateStamp the Portfolio Weights

```{r}

for (OptimizationType in 1:6){
  for(Copula in 1:4){
  
     PortfolioWeights[[OptimizationType]][[Copula]] <- 
        as.xts(PortfolioWeights[[OptimizationType]][[Copula]], order.by = as.Date(TempDate))
 }
}


rm(OptimizationType,Copula)
```



Individual Crypto Performance - Think of it as if we were investing in one specific cryptocurrency.
Note: We start investing in a particular crypto from the date it is included in the cryptofund. So it doesn't matter if we had the dataset starting before it was invested in the fund.
```{r}

IndividualCrypto <- AssetReturns

for (ColNum in 1:ncol(IndividualCrypto)){
IndividualCrypto[min(which(!is.na(IndividualCrypto[,ColNum]))),ColNum] <- 0
}
temp <- IndividualCrypto+1
cp <- function(x){x %>% na.omit %>% cumprod}

IndividualEvolution <- xts(x = matrix(data = NA, nrow = nrow(IndividualCrypto), ncol = ncol(IndividualCrypto)), order.by = index(IndividualCrypto))
colnames(IndividualEvolution) <- colnames(IndividualCrypto)

for(i in 1:ncol(IndividualCrypto)){
  aa <- cp(temp[,i])
  IndividualEvolution[index(aa),i] <- aa
}

rm(aa,cp,temp,IndividualCrypto,i,ColNum)
```

SP500
```{r}
library(quantmod)
getSymbols("^GSPC", src = "yahoo", from = as.Date("2013-04-28"), to = as.Date("2020-04-30"))
SP500Price <- GSPC$GSPC.Adjusted
rm(GSPC)

SP500 <-SP500Price %>% Return.calculate(method = "discrete") %>% na.omit
colnames(SP500) <- colnames(SP500Price) <- "SP500"

```


```{r}
Date <- index(AssetReturns)

SP500PeriodicReturns <- xts(x = matrix(data = NA, nrow = nrow(AssetReturns), ncol = 1), order.by = index(AssetReturns))
for(i in 1:length(Date)){
  if (i == 1){SP500PeriodicReturns[i,] <- 0 }
  else{
    Start <- which.min(abs(Date[i]-index(SP500)))
    SP500PeriodicReturns[i,] <- SP500[(Start-29):Start,] %>% +1 %>% prod %>% - 1
  }
}
colnames(SP500PeriodicReturns) <- "SP500"


SP500Evolution <-list()
a <- xts(x = matrix(data = NA, nrow = nrow(AssetReturns), ncol = 1), order.by = index(AssetReturns))

SP500Evolution <- list.append(SP500Evolution,a)
for(i in 1:68){
a <- a[-1,]
SP500Evolution <- list.append(SP500Evolution,a)
}


SP500Evolution <- cumprod(SP500PeriodicReturns+1)

rm(Date,Start,i)

```


Creating Portfolio Returns and Evolution

Initializing the variables -- PortfolioReturns and Evolution
```{r, echo=FALSE}

PortfolioReturns <- list(NaivePortfolio = list(), MinSD = list(), MinES = list(), Sharpe = list(), Starr = list(), MaxMean = list())

PortfolioEvolution <- list()
```

```{r}

for (OptimizationType in 1:6){

  Copulas <- list()

  for(Copula in 1:4){
     a <- lag.xts(PortfolioWeights[[OptimizationType]][[Copula]])
     a <- a[-1,]
     
     TempCop <- a * AssetReturns
     c <- index(TempCop)
     Temp <- as.xts(rowSums(TempCop, na.rm = TRUE), order.by = c)
 
     Copulas <- list.append(Copulas, Temp)
     rm(TempCop, Temp,a)
  }
  names(Copulas) <- names(PortfolioWeights[[OptimizationType]])
  PortfolioReturns[[OptimizationType]] <-   Copulas
  PortfolioReturns[[OptimizationType]] <-   sapply(PortfolioReturns[[OptimizationType]],unlist)
  PortfolioReturns[[OptimizationType]] <- as.xts(PortfolioReturns[[OptimizationType]], 
                                                           order.by = c)
  colnames(PortfolioReturns[[OptimizationType]]) <- gsub(x =                                                colnames(PortfolioReturns[[OptimizationType]]),"Weights","Returns")
rm(c)
}
PortfolioReturns<- do.call(cbind,PortfolioReturns)
z<- xts(x = t(rep(0,ncol(PortfolioReturns))), order.by = as.Date("2014-09-10")) # Don't forget to change the first investment date from 2014-09-10
colnames(z) <- colnames(PortfolioReturns)
z <- rbind.xts(z,PortfolioReturns) 
PortfolioEvolution <-  cumprod(z+1)
rm(z)

rm(Copula,OptimizationType)



```



Calculating Annualized Returns, Standard Deviation and CAGR of the Portfolios

Annualized Returns and Std Deviation ---- Returns

CAGR ---- Evolution

```{r}
pfactor <- 365/30

PerformanceMetrics <- list()


Evolution <- merge.xts(SP500Evolution,IndividualEvolution,PortfolioEvolution)
Returns <- merge.xts(SP500PeriodicReturns,AssetReturns,PortfolioReturns) 

CAGR <- Evolution[nrow(Evolution),]^(pfactor/(nrow(Evolution)-1)) - 1
CAGR <- setNames(as.numeric(CAGR), colnames(CAGR))
MEAN <- colMeans(Returns[-1,], na.rm = TRUE)*pfactor
STD <- colStdevs(Returns[-1,],na.rm = TRUE)*sqrt(pfactor)

g <- cbind(MEAN,STD,CAGR)
PerformanceMetrics <- t(g)

colnames(PerformanceMetrics) <- gsub(x = colnames(PerformanceMetrics), ".Returns","")

rm(Evolution, Returns, CAGR, MEAN, STD,g)

   
rm(pfactor)   
```


Converting lists and xts to Data.frame coz its easier to extract data using dplyr and graph them 
```{r}
#Conventional

for (i in 1:6){
colnames(ConvPortfolioWeights[[i]]) <- paste(colnames(ConvPortfolioWeights[[i]]), "Conv",names(ConvPortfolioWeights)[i],"Weights" , sep = '.')
}

DFConvPortfolioWeights <- Reduce(merge.xts,ConvPortfolioWeights)

DFConvPortfolioWeights <- data.frame(Date = index(DFConvPortfolioWeights), coredata(DFConvPortfolioWeights))


#Copula

for ( i in 1:6){
  for (cop in 1:4){
colnames(PortfolioWeights[[i]][[cop]]) <- paste(colnames(PortfolioWeights[[i]][[cop]]), 
                                                names(PortfolioWeights[[i]])[cop],sep = '.')
  }
}

DFPortfolioWeights <- list()
for (i in 1:6) {
  DFPortfolioWeights[[i]] <- Reduce(merge.xts, PortfolioWeights[[i]])  
}
DFPortfolioWeights <- Reduce(merge.xts, DFPortfolioWeights)

DFPortfolioWeights <- data.frame(Date = index(DFPortfolioWeights), coredata(DFPortfolioWeights))


colnames(PortfolioEvolution) <- gsub(colnames(PortfolioEvolution), pattern = "Returns", replacement = "Evolution")
colnames(ConvPortfolioEvolution) <- paste("Conv",colnames(ConvPortfolioEvolution), "Evolution", sep = ".")

## Evolution - Conv, Copula, Individual, SP500


DFConvEvolution <- data.frame(Date = index(ConvPortfolioEvolution), coredata(ConvPortfolioEvolution))
DFCopulaEvolution <- data.frame(Date = index(PortfolioEvolution), coredata(PortfolioEvolution))
DFSP500Evolution <- data.frame(Date = index(SP500Evolution), coredata(SP500Evolution))
DFIndividualEvolution <-  data.frame(Date = index(IndividualEvolution), coredata(IndividualEvolution))

```

All together - Weights -- Conv and Copula, Evolution -- Conv, Copula, Sp500, and Individual
```{r}



WeightsAndEvolution <- full_join(full_join(DFPortfolioWeights,DFConvPortfolioWeights),
                                 full_join(DFCopulaEvolution,full_join(DFSP500Evolution,                                                                    full_join(DFIndividualEvolution,DFConvEvolution))))

# 
# WeightsAndEvolution <- full_join(full_join(DFPortfolioWeights,DFConvPortfolioWeights),
#                                  full_join(PortfolioEvolution,full_join(SP500Evolution,                                                                    full_join(IndividualEvolution,ConvPortfolioEvolution))))


```


Part 6: Report Generation and such

```{r}
DFPortfolioReturns %>% select(contains("P.C")) %>% as.xts %>% chart.CumReturns()
```



